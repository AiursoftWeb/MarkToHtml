@using Aiursoft.MarkToHtml.Controllers
@model Aiursoft.MarkToHtml.Models.MermaidViewModels.MermaidViewModel

<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3>@Localizer["Mermaid to HTML Converter"]</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <p class="mb-0 text-muted">@Localizer["Type Mermaid on the left, see SVG preview on the right."]</p>
    </div>
</div>

@if (Model.SavedSuccessfully)
{
    <div class="alert alert-success alert-dismissible" role="alert">
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        <div class="d-flex">
            <div class="alert-icon pe-3">
                <i class="align-middle" data-lucide="alert-triangle"></i>
            </div>
            <div class="alert-message">
                <strong>@Localizer["Success!"]</strong>
                @Localizer["Diagram updated successfully."]
            </div>
        </div>
    </div>
}

<form asp-action="Mermaid" method="post" id="mermaid-form">
    <div class="row">
        <div class="col-lg-6 d-flex">
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="align-middle" data-lucide="workflow">&nbsp;</i>
                        @Localizer["Mermaid Input"]
                    </h5>
                </div>
                <div class="card-body p-2">
                    @if (Model.IsEditing)
                    {
                        <input type="hidden" asp-for="DocumentId" />
                        <div class="mb-3">
                            <label asp-for="Title" class="form-label">@Localizer["Diagram Title (optional)"]</label>
                            <input asp-for="Title" class="form-control form-control-lg"
                                   placeholder="@Localizer["Diagram Title (optional)"]" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>
                    }

                    <textarea asp-for="InputMermaid" class="form-control" id="mermaid-editor"
                        placeholder="@Localizer["Type your Mermaid here..."]"></textarea>
                    <span asp-validation-for="InputMermaid" class="text-danger"></span>
                </div>
            </div>
        </div>

        <div class="col-lg-6 d-flex flex-column">
            <div class="tab flex-grow-1">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" href="#preview" data-bs-toggle="tab" role="tab" aria-selected="true">
                            <i class="align-middle" data-lucide="eye">&nbsp;</i>
                            @Localizer["Preview"]
                        </a>
                    </li>
                </ul>
                <div class="tab-content pt-3">
                    <div class="tab-pane active show" id="preview" role="tabpanel">
                        <div class="d-flex justify-content-end mb-2">
                            <button type="button" id="download-svg-button" class="btn btn-outline-primary">
                                <i class="align-middle" data-lucide="download"></i> @Localizer["Download SVG"]
                            </button>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.OutputHtml))
                        {
                            <div id="preview-area">
                                @Html.Raw(Model.OutputHtml)
                            </div>
                        }
                        else
                        {
                            <div class="text-center p-5">
                                <p class="text-muted">@Localizer["Preview will appear here after conversion."]</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col text-center">
            @if ((User.Identity?.IsAuthenticated ?? false) && Model.IsEditing)
            {
                <a asp-action="History" class="btn btn-outline-secondary btn-lg mr-2">
                    <i class="align-middle" data-lucide="workflow">&nbsp;</i>
                    @Localizer["My Mermaid Charts"]
                </a>
            }

            <button type="submit" class="btn btn-primary btn-lg">
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <i class="align-middle" data-lucide="check-circle">&nbsp;</i>
                    @Localizer["Convert and save"]
                }
                else
                {
                    <i class="align-middle" data-lucide="chevrons-right">&nbsp;</i>
                    @Localizer["Convert to SVG"]
                }
            </button>
        </div>
    </div>
</form>

@{
    var isDarkMode = Context.Request.Cookies[ThemeController.ThemeCookieKey] == true.ToString();
    var theme = isDarkMode ? "material" : "eclipse";
}

@* ReSharper disable once Razor.SectionNotResolved *@
@section styles {
    <link rel="stylesheet" href="~/node_modules/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" href="~/node_modules/codemirror/theme/@(theme).css" />
    <style>
        .CodeMirror,
        #preview {
            max-height: 70vh;
        }

        #preview {
            overflow-y: auto;
        }

        .CodeMirror {
            border: 1px solid #dee2e6;
            height: auto;
            display: flex;
            flex-direction: column;
        }

        .CodeMirror-scroll {
            flex-grow: 1;
            overflow: auto !important;
            position: relative;
        }
    </style>
}

@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script src="~/node_modules/codemirror/lib/codemirror.js"></script>
    <script src="~/node_modules/codemirror/mode/markdown/markdown.js"></script>
    <script src="~/node_modules/codemirror/mode/xml/xml.js"></script>
    <script src="~/node_modules/codemirror/addon/edit/closebrackets.js"></script>
    <script src="~/node_modules/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="~/node_modules/mermaid/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let mermaidEditorInstance;
            let latestSvg = '';

            if ($.validator) {
                $.validator.setDefaults({
                    ignore: []
                });
            }

            if (typeof CodeMirror !== 'undefined') {
                if (!document.getElementById('mermaid-editor').CodeMirror) {
                    mermaidEditorInstance = CodeMirror.fromTextArea(document.getElementById('mermaid-editor'), {
                        lineNumbers: true,
                        mode: 'markdown',
                        theme: '@(theme)',
                        viewportMargin: Infinity
                    });
                    mermaidEditorInstance.on('change', function () {
                        mermaidEditorInstance.save();
                    });
                }
            }

            if (window.mermaid) {
                mermaid.initialize({ startOnLoad: false, theme: '@(isDarkMode ? "dark" : "default")' });
            }

            function renderPreview() {
                const previewArea = document.getElementById('preview-area');
                const input = mermaidEditorInstance ? mermaidEditorInstance.getValue() : document.getElementById('mermaid-editor').value;
                if (!previewArea || !input) return;

                const container = document.createElement('div');
                const id = 'mermaid-' + Math.random().toString(36).slice(2);

                // Encode to avoid XSS; server already encoded, but for live typing keep safe
                const encoded = input
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                container.innerHTML = `<pre class="mermaid">${encoded}</pre>`;
                previewArea.innerHTML = '';
                previewArea.appendChild(container);

                if (window.mermaid) {
                    try {
                        mermaid.parse(input); // validate early
                        mermaid.render(id, input).then(({ svg }) => {
                            // Update preview with SVG
                            previewArea.innerHTML = svg;
                            latestSvg = svg;
                        }).catch(err => {
                            latestSvg = '';
                            previewArea.innerHTML = `<pre class=\"text-danger\">${(err && (err.message || err)) || 'Render error'}</pre>`;
                        });
                    } catch (e) {
                        latestSvg = '';
                        previewArea.innerHTML = `<pre class=\"text-danger\">${(e && (e.message || e)) || 'Parse error'}</pre>`;
                    }
                }
            }

            // If server has produced OutputHtml, render it to SVG as well
            renderPreview();

            // Download button logic
            const downloadBtn = document.getElementById('download-svg-button');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function () {
                    if (!latestSvg) {
                        return;
                    }
                    const blob = new Blob([latestSvg], { type: 'image/svg+xml;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `diagram-${new Date().toISOString().replace(/[:.]/g, '-')}.svg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }

            // Re-render on input changes
            if (mermaidEditorInstance) {
                mermaidEditorInstance.on('change', function () {
                    renderPreview();
                });
            }
        });
    </script>
}


