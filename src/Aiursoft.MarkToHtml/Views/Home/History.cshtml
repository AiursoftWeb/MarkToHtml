@using Aiursoft.WebTools
@model Aiursoft.MarkToHtml.Models.HomeViewModels.HistoryViewModel

<style>
    .clickable-row {
        cursor: pointer;
    }
</style>

<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3>@Localizer["My Documents"]</h3>
    </div>

    <div class="col-auto ms-auto mt-n1">
        <a asp-controller="Home" asp-action="Index" class="btn btn-primary">
            <i class="align-middle" data-lucide="file-plus"></i> @Localizer["Create a new document"]
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
            <div>
                <h5 class="card-title mb-1">@Localizer["All My Documents"]</h5>
                <h6 class="card-subtitle text-muted mb-0">@Localizer["A list of all documents you have created."]</h6>
            </div>
            <form method="get"
                  asp-action="History"
                  class="ms-md-auto w-100 w-md-auto"
                  role="search">
                <div class="input-group">
                    <input type="search"
                           name="search"
                           value="@Model.SearchQuery"
                           class="form-control"
                           placeholder="@Localizer["Search my documents..."]"
                           aria-label="@Localizer["Search my documents"]" />
                    @if (!string.IsNullOrWhiteSpace(Model.SearchQuery))
                    {
                        <a asp-action="History" class="btn btn-outline-secondary">
                            <i class="align-middle" data-lucide="x-circle"></i>
                            <span class="d-none d-lg-inline">@Localizer["Clear"]</span>
                        </a>
                    }
                    <button class="btn btn-primary" type="submit">
                        <i class="align-middle" data-lucide="search"></i>
                        <span class="d-none d-sm-inline">@Localizer["Search"]</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    @if (!Model.MyDocuments.Any())
    {
        <div class="card-body">
            <div class="alert alert-info mb-0" role="alert">
                @if (string.IsNullOrWhiteSpace(Model.SearchQuery))
                {
                    @Localizer["You have not created any documents yet."]
                }
                else
                {
                    @Localizer["No documents match your search."]
                }
            </div>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                <tr>
                    <th>@Localizer["Title"]</th>
                    <th>@Localizer["Visibility"]</th> @* 新增列：可见性 *@
                    <th>@Localizer["Creation Time"]</th>
                    <th>@Localizer["Length"]</th>
                    <th class="text-end">@Localizer["Actions"]</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var doc in Model.MyDocuments)
                {
                    var rowUrl = doc.PublicId.HasValue ? Url.Action("View", "Public", new { publicId = doc.PublicId }) : Url.Action("Edit", new { id = doc.Id });
                    <tr class="clickable-row" data-href="@rowUrl">
                        <td>
                            @if (string.IsNullOrWhiteSpace(doc.Title))
                            {
                                <label class="text-muted">(no title)</label>
                            }
                            else
                            {
                                @doc.Title
                            }
                        </td>
                        <td>
                            @if (doc.PublicId.HasValue)
                            {
                                <span class="badge bg-success-subtle text-success border border-success">
                                    <i class="align-middle" data-lucide="globe"></i> @Localizer["Public"]
                                </span>
                            }
                            else if (doc.DocumentShares.Any())
                            {
                                <span class="badge bg-info-subtle text-info border border-info">
                                    <i class="align-middle" data-lucide="users"></i> @Localizer["Internal"]
                                </span>
                            }
                            else
                            {
                                <span class="text-muted small">
                                    <i class="align-middle" data-lucide="lock"></i> @Localizer["Private"]
                                </span>
                            }
                        </td>
                        <td>
                            <label class="text-muted" data-utc-time="@doc.CreationTime.ToHtmlDateTime()"></label>
                        </td>
                        <td>@(doc.Content?.Length ?? 0)</td>
                        <td class="text-end">
                            <a asp-action="Edit" asp-route-id="@doc.Id" class="btn btn-sm btn-outline-primary">
                                <i class="align-middle" data-lucide="edit-2"></i> @Localizer["Edit"]
                            </a>
                            <a asp-action="ManageShares" asp-route-id="@doc.Id" class="btn btn-sm btn-outline-info">
                                <i class="align-middle" data-lucide="share-2"></i> @Localizer["Share"]
                            </a>
                            <a asp-action="Delete" asp-route-id="@doc.Id" class="btn btn-sm btn-outline-danger">
                                <i class="align-middle" data-lucide="trash-2"></i> @Localizer["Delete"]
                            </a>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const rows = document.querySelectorAll(".clickable-row");
            rows.forEach(row => {
                row.addEventListener("click", function (event) {
                    const target = event.target;
                    // Prevent navigation if a link or button was clicked inside the row
                    if (!target.matches('a, a *, button, button *')) {
                        window.location.href = row.dataset.href;
                    }
                });
            });
        });
    </script>
}
