@using Aiursoft.MarkToHtml.Controllers
@model Aiursoft.MarkToHtml.Models.HomeViewModels.MermaidViewModel

<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3>@Localizer["Mermaid to HTML Converter"]</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <p class="mb-0 text-muted">@Localizer["Type Mermaid on the left, see HTML and preview on the right."]</p>
    </div>
</div>

<form asp-action="Mermaid" method="post" id="mermaid-form">
    <div class="row">
        <div class="col-lg-6 d-flex">
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="align-middle" data-lucide="workflow">&nbsp;</i>
                        @Localizer["Mermaid Input"]
                    </h5>
                </div>
                <div class="card-body p-2">
                    <textarea asp-for="InputMermaid" class="form-control" id="mermaid-editor"
                        placeholder="@Localizer["Type your Mermaid here..."]"></textarea>
                    <span asp-validation-for="InputMermaid" class="text-danger"></span>
                </div>
            </div>
        </div>

        <div class="col-lg-6 d-flex flex-column">
            <div class="tab flex-grow-1">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" href="#code" data-bs-toggle="tab" role="tab" aria-selected="true">
                            <i class="align-middle" data-lucide="code-2">&nbsp;</i>
                            @Localizer["Code"]
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" href="#preview" data-bs-toggle="tab" role="tab" aria-selected="false">
                            <i class="align-middle" data-lucide="eye">&nbsp;</i>
                            @Localizer["Preview"]
                        </a>
                    </li>
                </ul>
                <div class="tab-content pt-3">
                    <div class="tab-pane active show" id="code" role="tabpanel">
                        <button type="button" id="copy-button" class="btn btn-outline-primary mb-2"
                            title="@Localizer["Copy HTML to clipboard"]">
                            <i class="align-middle" data-lucide="copy"></i> @Localizer["Copy"]
                        </button>
                        <textarea class="form-control" rows="25" id="html-output" readonly>@Model.OutputHtml</textarea>
                    </div>
                    <div class="tab-pane" id="preview" role="tabpanel">
                        @if (!string.IsNullOrEmpty(Model.OutputHtml))
                        {
                            <div id="preview-area">
                                @Html.Raw(Model.OutputHtml)
                            </div>
                        }
                        else
                        {
                            <div class="text-center p-5">
                                <p class="text-muted">@Localizer["Preview will appear here after conversion."]</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col text-center">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="align-middle" data-lucide="chevrons-right">&nbsp;</i>
                @Localizer["Convert to HTML"]
            </button>
        </div>
    </div>
</form>

@{
    var isDarkMode = Context.Request.Cookies[ThemeController.ThemeCookieKey] == true.ToString();
    var theme = isDarkMode ? "material" : "eclipse";
}

@section styles {
    <link rel="stylesheet" href="~/node_modules/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" href="~/node_modules/codemirror/theme/@(theme).css" />
    <style>
        .CodeMirror,
        #preview {
            max-height: 70vh;
        }

        #preview {
            overflow-y: auto;
        }

        .CodeMirror {
            border: 1px solid #dee2e6;
            height: auto;
            display: flex;
            flex-direction: column;
        }

        .CodeMirror-scroll {
            flex-grow: 1;
            overflow: auto !important;
            position: relative;
        }
    </style>
}

@section scripts {
    <script src="~/node_modules/codemirror/lib/codemirror.js"></script>
    <script src="~/node_modules/codemirror/mode/markdown/markdown.js"></script>
    <script src="~/node_modules/codemirror/mode/xml/xml.js"></script>
    <script src="~/node_modules/codemirror/addon/edit/closebrackets.js"></script>
    <script src="~/node_modules/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let mermaidEditorInstance;
            let htmlOutputInstance;

            if ($.validator) {
                $.validator.setDefaults({
                    ignore: []
                });
            }

            if (typeof CodeMirror !== 'undefined') {
                if (!document.getElementById('mermaid-editor').CodeMirror) {
                    mermaidEditorInstance = CodeMirror.fromTextArea(document.getElementById('mermaid-editor'), {
                        lineNumbers: true,
                        mode: 'markdown',
                        theme: '@(theme)',
                        viewportMargin: Infinity
                    });
                    mermaidEditorInstance.on('change', function () {
                        mermaidEditorInstance.save();
                    });
                }
                if (!document.getElementById('html-output').CodeMirror) {
                    htmlOutputInstance = CodeMirror.fromTextArea(document.getElementById('html-output'), {
                        lineNumbers: true,
                        mode: 'xml',
                        readOnly: true,
                        theme: '@(theme)',
                        viewportMargin: Infinity
                    });
                }
            }

            if (window.mermaid) {
                mermaid.initialize({ startOnLoad: false, theme: '@(isDarkMode ? "dark" : "default")' });
            }

            function renderPreview() {
                const previewArea = document.getElementById('preview-area');
                const input = mermaidEditorInstance ? mermaidEditorInstance.getValue() : document.getElementById('mermaid-editor').value;
                if (!previewArea || !input) return;

                const container = document.createElement('div');
                const id = 'mermaid-' + Math.random().toString(36).slice(2);

                // Encode to avoid XSS; server already encoded, but for live typing keep safe
                const encoded = input
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                container.innerHTML = `<pre class="mermaid">${encoded}</pre>`;
                previewArea.innerHTML = '';
                previewArea.appendChild(container);

                if (window.mermaid && htmlOutputInstance) {
                    try {
                        mermaid.parse(input); // validate early
                        mermaid.render(id, input).then(({ svg }) => {
                            // Update preview with SVG
                            previewArea.innerHTML = svg;
                            // Update code tab with HTML
                            htmlOutputInstance.setValue(svg);
                        }).catch(err => {
                            htmlOutputInstance.setValue(`<pre class=\"text-danger\">${(err && (err.message || err)) || 'Render error'}</pre>`);
                        });
                    } catch (e) {
                        htmlOutputInstance.setValue(`<pre class=\"text-danger\">${(e && (e.message || e)) || 'Parse error'}</pre>`);
                    }
                }
            }

            // If server has produced OutputHtml, render it to SVG as well
            renderPreview();

            const copyButton = document.getElementById('copy-button');
            if (copyButton && htmlOutputInstance) {
                copyButton.addEventListener('click', function () {
                    const codeToCopy = htmlOutputInstance.getValue();
                    if (!codeToCopy) return;
                    navigator.clipboard.writeText(codeToCopy).then(function () {
                        copyButton.innerHTML = `@Localizer["Copied!"]`;
                    }, function (err) {
                        console.error('Could not copy text: ', err);
                        alert('@Localizer["Failed to copy text."]');
                    });
                });
            }

            // Re-render on input changes
            if (mermaidEditorInstance) {
                mermaidEditorInstance.on('change', function () {
                    renderPreview();
                });
            }
        });
    </script>
}


