@model Aiursoft.MarkToHtml.Models.HomeViewModels.ManageSharesViewModel
@inject IViewLocalizer Localizer
@inject Aiursoft.MarkToHtml.Services.FileStorage.StorageService StorageService



<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h3>@Localizer["Manage Shares"]</h3>
                <p class="text-muted">@Localizer["Document:"]: <strong>@Model.DocumentTitle</strong></p>
            </div>
            <div>
                <a asp-action="Edit" asp-route-id="@Model.DocumentId" class="btn btn-outline-secondary">
                    <i class="align-middle" data-lucide="arrow-left"></i> @Localizer["Back to Document"]
                </a>
            </div>
        </div>
    </div>
</div>

@* Add New Share Card *@
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="align-middle" data-lucide="user-plus"></i> @Localizer["Add New Share"]
                </h5>
            </div>
            <div class="card-body">
                <form asp-action="AddShare" asp-route-id="@Model.DocumentId" method="post" id="add-share-form">
                    @Html.AntiForgeryToken()

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["Share with"]</label>

                            <div class="btn-group w-100 mb-3" role="group">
                                <input type="radio" class="btn-check" name="shareType" id="shareTypeRole" value="role" checked>
                                <label class="btn btn-outline-primary" for="shareTypeRole">
                                    <i class="align-middle" data-lucide="users"></i> @Localizer["Role"]
                                </label>

                                <input type="radio" class="btn-check" name="shareType" id="shareTypeUser" value="user">
                                <label class="btn btn-outline-primary" for="shareTypeUser">
                                    <i class="align-middle" data-lucide="user"></i> @Localizer["Specific User"]
                                </label>
                            </div>

                            @* Role Selection *@
                            <div id="role-selection">
                                <select class="form-select" name="TargetRoleId" id="roleSelect">
                                    <option value="">@Localizer["Select a role..."]</option>
                                    @foreach (var role in Model.AvailableRoles)
                                    {
                                        <option value="@role.Id">@role.Name</option>
                                    }
                                </select>

                                @* Role Preview *@
                                <div id="role-preview" class="mt-3 p-3 bg-light rounded d-none">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="align-middle me-2" data-lucide="users"></i>
                                        <strong id="role-preview-name"></strong>
                                    </div>
                                    <div class="small text-muted mb-2">
                                        <span id="role-preview-count"></span> @Localizer["members"]
                                    </div>
                                    <div id="role-preview-avatars" class="d-flex gap-2">
                                        @* Avatars will be populated by JavaScript *@
                                    </div>
                                </div>
                            </div>

                            @* User Selection with Autocomplete *@
                            <div id="user-selection" class="d-none">
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="userSearch" placeholder="@Localizer["Type to search users..."]" autocomplete="off">
                                    <input type="hidden" name="TargetUserId" id="selectedUserId">

                                    @* Autocomplete dropdown *@
                                    <div id="userSearchResults" class="position-absolute w-100 bg-white border rounded shadow-sm d-none" style="z-index: 1000; max-height: 300px; overflow-y: auto;">
                                        @* Results will be populated by JavaScript *@
                                    </div>
                                </div>

                                @* Selected user display *@
                                <div id="selectedUserDisplay" class="mt-2 p-2 bg-light rounded d-none">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <img id="selectedUserAvatar" src="" alt="" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                            <div>
                                                <div id="selectedUserName" class="fw-bold"></div>
                                                <div id="selectedUserUsername" class="small text-muted"></div>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearSelectedUser">
                                            <i class="align-middle" data-lucide="x"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">@Localizer["Permission"]</label>
                            <select class="form-select" name="Permission" required>
                                <option value="0">@Localizer["Read Only"]</option>
                                <option value="1">@Localizer["Editable"]</option>
                            </select>
                        </div>

                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="align-middle" data-lucide="plus"></i> @Localizer["Add"]
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@* Existing Shares *@
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="align-middle" data-lucide="share-2"></i> @Localizer["Existing Shares"]
                </h5>
            </div>
            <div class="card-body">
                @if (!Model.ExistingShares.Any())
                {
                    <div class="text-center text-muted py-4">
                        <i class="align-middle" data-lucide="inbox" style="width: 48px; height: 48px;"></i>
                        <p class="mt-3">@Localizer["No shares yet. Add one above to share this document."]</p>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                            <tr>
                                <th>@Localizer["Shared With"]</th>
                                <th>@Localizer["Type"]</th>
                                <th>@Localizer["Permission"]</th>
                                <th>@Localizer["Created"]</th>
                                <th class="text-end">@Localizer["Actions"]</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var share in Model.ExistingShares)
                            {
                                <tr>
                                    <td>
                                        @if (share.SharedWithUserId != null)
                                        {
                                            <div class="d-flex align-items-center">
                                                @if (share.SharedWithUser != null)
                                                {
                                                    <img src="@(StorageService.RelativePathToInternetUrl(share.SharedWithUser.AvatarRelativePath))?w=128&square=true" alt="Avatar" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                                    <span>@share.SharedWithUser.DisplayName</span>
                                                }
                                                else
                                                {
                                                    <i class="align-middle me-2" data-lucide="user"></i>
                                                    <span class="text-muted">@Localizer["User"] (@share.SharedWithUserId)</span>
                                                }
                                            </div>
                                        }
                                        else if (share.SharedWithRoleId != null)
                                        {
                                            var roleName = Model.AvailableRoles.FirstOrDefault(r => r.Id == share.SharedWithRoleId)?.Name ?? share.SharedWithRoleId;
                                            <div class="d-flex align-items-center">
                                                <i class="align-middle me-2" data-lucide="users"></i>
                                                <span>@roleName</span>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (share.SharedWithUserId != null)
                                        {
                                            <span class="badge bg-info">@Localizer["User"]</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-primary">@Localizer["Role"]</span>
                                        }
                                    </td>
                                    <td>
                                        @if (share.Permission == Aiursoft.MarkToHtml.Entities.SharePermission.ReadOnly)
                                        {
                                            <span class="badge bg-secondary">@Localizer["Read Only"]</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">@Localizer["Editable"]</span>
                                        }
                                    </td>
                                    <td>
                                        <label class="text-muted" data-utc-time="@share.CreationTime.ToString("o")"></label>
                                    </td>
                                    <td class="text-end">
                                        <form asp-action="RemoveShare" asp-route-id="@share.Id" method="post" class="d-inline" onsubmit="return confirm('@Localizer["Are you sure you want to remove this share?"]')">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="align-middle" data-lucide="trash-2"></i> @Localizer["Remove"]
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@* Error Modal *@
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-danger">
                <h5 class="modal-title">
                    <i class="align-middle me-2" data-lucide="alert-circle"></i> @Localizer["Error"]
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage">@Localizer["An error occurred while processing your request."]</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Close"]</button>
            </div>
        </div>
    </div>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const shareTypeRole = document.getElementById('shareTypeRole');
            const shareTypeUser = document.getElementById('shareTypeUser');
            const roleSelection = document.getElementById('role-selection');
            const userSelection = document.getElementById('user-selection');
            const roleSelect = document.getElementById('roleSelect');
            const rolePreview = document.getElementById('role-preview');

            const userSearch = document.getElementById('userSearch');
            const userSearchResults = document.getElementById('userSearchResults');
            const selectedUserId = document.getElementById('selectedUserId');
            const selectedUserDisplay = document.getElementById('selectedUserDisplay');
            const clearSelectedUser = document.getElementById('clearSelectedUser');

            let searchTimeout;
            let currentPage = 1;
            let isLoading = false;
            let hasMore = true;
            let currentQuery = '';
            const pageSize = 10;

            // Toggle between role and user selection
            shareTypeRole.addEventListener('change', function() {
                if (this.checked) {
                    roleSelection.classList.remove('d-none');
                    userSelection.classList.add('d-none');
                    roleSelect.setAttribute('name', 'TargetRoleId');
                    selectedUserId.removeAttribute('name');
                }
            });

            shareTypeUser.addEventListener('change', function() {
                if (this.checked) {
                    userSelection.classList.remove('d-none');
                    roleSelection.classList.add('d-none');
                    roleSelect.removeAttribute('name');
                    selectedUserId.setAttribute('name', 'TargetUserId');
                    rolePreview.classList.add('d-none');
                }
            });

            // Load role info when selected
            roleSelect.addEventListener('change', async function() {
                const roleId = this.value;
                if (!roleId) {
                    rolePreview.classList.add('d-none');
                    return;
                }

                try {
                    const response = await fetch(`/api/roles/${roleId}/info`);
                    if (!response.ok) throw new Error('Failed to fetch role info');

                    const data = await response.json();

                    // Update preview
                    document.getElementById('role-preview-name').textContent = data.name;
                    document.getElementById('role-preview-count').textContent = data.totalMembers;

                    // Update avatars
                    const avatarsContainer = document.getElementById('role-preview-avatars');
                    avatarsContainer.innerHTML = '';
                    data.previewMembers.forEach(member => {
                        const img = document.createElement('img');
                        img.src = member.avatarUrl;
                        img.alt = member.displayName;
                        img.title = member.displayName;
                        img.className = 'rounded-circle';
                        img.style.width = '40px';
                        img.style.height = '40px';
                        img.style.objectFit = 'cover';
                        img.style.border = '2px solid white';
                        avatarsContainer.appendChild(img);
                    });

                    if (data.totalMembers > 4) {
                        const more = document.createElement('div');
                        more.className = 'rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center';
                        more.style.width = '40px';
                        more.style.height = '40px';
                        more.style.fontSize = '12px';
                        more.textContent = '+' + (data.totalMembers - 4);
                        avatarsContainer.appendChild(more);
                    }

                    rolePreview.classList.remove('d-none');
                } catch (error) {
                    console.error('Error loading role info:', error);
                }
            });

            // User search autocomplete
            userSearch.addEventListener('input', function() {
                const query = this.value.trim();
                currentQuery = query;

                clearTimeout(searchTimeout);

                if (query.length < 3) {
                    userSearchResults.classList.add('d-none');
                    userSearchResults.innerHTML = '';
                    return;
                }

                // Reset pagination
                currentPage = 1;
                hasMore = true;
                userSearchResults.innerHTML = '';
                userSearchResults.scrollTop = 0;

                searchTimeout = setTimeout(() => loadUsers(query, 1), 300);
            });

            async function loadUsers(query, page) {
                if (isLoading || !hasMore) return;
                isLoading = true;

                try {
                    const response = await fetch(`/api/users/search?query=${encodeURIComponent(query)}&page=${page}&pageSize=${pageSize}`);
                    if (!response.ok) throw new Error('Search failed');

                    const data = await response.json();
                    const users = data.users;

                    if (users.length < pageSize || page >= data.totalPages) {
                        hasMore = false;
                    }

                    if (page === 1 && users.length === 0) {
                        userSearchResults.innerHTML = '<div class="p-3 text-muted">@Localizer["No users found"]</div>';
                        userSearchResults.classList.remove('d-none');
                        isLoading = false;
                        return;
                    }

                    let html = '';
                    users.forEach(user => {
                        html += `
                            <div class="user-search-item p-2 d-flex align-items-center" style="cursor: pointer;" data-user-id="${user.id}" data-user-name="${user.displayName}" data-user-username="${user.userName}" data-user-avatar="${user.avatarUrl}">
                                <img src="${user.avatarUrl}" alt="${user.displayName}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                <div>
                                    <div class="fw-bold">${user.displayName}</div>
                                    <div class="small text-muted">${user.userName}</div>
                                </div>
                            </div>
                        `;
                    });

                    if (page === 1) {
                        userSearchResults.innerHTML = html;
                    } else {
                        // Append
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        while (tempDiv.firstChild) {
                            userSearchResults.appendChild(tempDiv.firstChild);
                        }
                    }

                    userSearchResults.classList.remove('d-none');

                } catch (error) {
                    console.error('Error searching users:', error);
                    if (page === 1) {
                        userSearchResults.innerHTML = '<div class="p-3 text-danger">@Localizer["Error searching users"]</div>';
                        userSearchResults.classList.remove('d-none');
                    }
                } finally {
                    isLoading = false;
                }
            }

            // Scroll handler for infinite scroll
            userSearchResults.addEventListener('scroll', function() {
                if (this.scrollTop + this.clientHeight >= this.scrollHeight - 20) {
                    if (hasMore && !isLoading) {
                        currentPage++;
                        loadUsers(currentQuery, currentPage);
                    }
                }
            });

            // Event delegation for clicking items
            userSearchResults.addEventListener('click', function(e) {
                const item = e.target.closest('.user-search-item');
                if (item) {
                    selectUser(
                        item.dataset.userId,
                        item.dataset.userName,
                        item.dataset.userUsername,
                        item.dataset.userAvatar
                    );
                }
            });

            // Hover effects via delegation
            userSearchResults.addEventListener('mouseover', function(e) {
                const item = e.target.closest('.user-search-item');
                if (item) item.style.backgroundColor = '#f8f9fa';
            });

            userSearchResults.addEventListener('mouseout', function(e) {
                const item = e.target.closest('.user-search-item');
                if (item) item.style.backgroundColor = '';
            });

            function selectUser(id, name, username, avatar) {
                selectedUserId.value = id;
                userSearch.value = '';
                userSearchResults.classList.add('d-none');

                document.getElementById('selectedUserAvatar').src = avatar;
                document.getElementById('selectedUserName').textContent = name;
                document.getElementById('selectedUserUsername').textContent = username;
                selectedUserDisplay.classList.remove('d-none');
            }

            clearSelectedUser.addEventListener('click', function() {
                selectedUserId.value = '';
                selectedUserDisplay.classList.add('d-none');
                userSearch.value = '';
            });

            // Close search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!userSearch.contains(e.target) && !userSearchResults.contains(e.target)) {
                    userSearchResults.classList.add('d-none');
                }
            });

            // Prevent form submission on enter in user search input
            userSearch.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    return false;
                }
            });

            // Check for error parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                const errorMessage = document.getElementById('errorMessage');
                if (error === 'duplicate') {
                    errorMessage.textContent = '@Localizer["This user or role already has access to this document."]';
                } else if (error === 'invalid') {
                    errorMessage.textContent = '@Localizer["Please select a valid user or role."].';
                }

                const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                errorModal.show();

                // Clean up URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        });
    </script>
}
