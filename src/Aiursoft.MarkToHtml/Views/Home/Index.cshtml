@using Aiursoft.MarkToHtml.Controllers
@model Aiursoft.MarkToHtml.Models.HomeViewModels.IndexViewModel

<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3>@Localizer["Markdown to HTML Converter"]</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <p class="mb-0 text-muted">@Localizer["A simple tool to convert your Markdown into clean, sanitized HTML."]</p>
    </div>
</div>

@if (Model.SavedSuccessfully)
{
    <div class="alert alert-success alert-dismissible" role="alert">
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        <div class="d-flex">
            <div class="alert-icon pe-3">
                <i class="align-middle" data-lucide="alert-triangle"></i>
            </div>
            <div class="alert-message">
                <strong>@Localizer["Success!"]</strong>
                @Localizer["Document updated successfully."]
            </div>
        </div>
    </div>
}

<form asp-action="Index" method="post" id="markdown-form">
    <div class="row">
        @* Left Column: Markdown Input *@
        <div class="col-lg-6 d-flex">
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="align-middle" data-lucide="file-text">&nbsp;</i>
                        @Localizer["Markdown Input"]
                    </h5>
                </div>
                <div class="card-body p-2">
                    @* Add this block for editing title if in editing mode *@
                    @if (Model.IsEditing)
                    {
                        <input type="hidden" asp-for="DocumentId" />
                        <div class="mb-3">
                            <label asp-for="Title" class="form-label">@Localizer["Document Title (optional)"]</label>
                            <input asp-for="Title" class="form-control form-control-lg"
                                placeholder="@Localizer["Document Title (optional)"]" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>
                    }

                    <textarea asp-for="InputMarkdown" class="form-control" id="markdown-editor"
                        placeholder="@Localizer["Type your Markdown here..."]"></textarea>
                    <span asp-validation-for="InputMarkdown" class="text-danger"></span>
                </div>
            </div>
        </div>

        @* Right Column: Standalone Tab Component *@
        <div class="col-lg-6 d-flex flex-column">

            @* The tab component now stands alone and fills the available space *@
            <div class="tab flex-grow-1">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        @* The 'active' class is now on the link (<a>), not the list item (<li>) *@
                        <a class="nav-link active" href="#code" data-bs-toggle="tab" role="tab" aria-selected="true">
                            <i class="align-middle" data-lucide="code-2">&nbsp;</i>
                            @Localizer["Code"]
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" href="#preview" data-bs-toggle="tab" role="tab" aria-selected="false">
                            <i class="align-middle" data-lucide="eye">&nbsp;</i>
                            @Localizer["Preview"]
                        </a>
                    </li>
                </ul>
                <div class="tab-content pt-3">
                    @* Code Pane *@
                    <div class="tab-pane active show" id="code" role="tabpanel">
                        <button type="button" id="copy-button" class="btn btn-outline-primary mb-2"
                            title="@Localizer["Copy HTML to clipboard"]">
                            <i class="align-middle" data-lucide="copy"></i> @Localizer["Copy"]
                        </button>
                        <textarea class="form-control" rows="25" id="html-output" readonly>@Model.OutputHtml</textarea>
                    </div>
                    @* Preview Pane *@
                    <div class="tab-pane" id="preview" role="tabpanel">
                        @if (!string.IsNullOrEmpty(Model.OutputHtml))
                        {
                            <button type="button" id="print-button" class="btn btn-outline-info mb-2"
                                title="@Localizer["Print Preview"]">
                                <i class="align-middle" data-lucide="printer"></i> @Localizer["Print"]
                            </button>

                            <div id="printable-area">
                                @Html.Raw(Model.OutputHtml)
                            </div>
                        }
                        else
                        {
                            <div class="text-center p-5">
                                <p class="text-muted">@Localizer["HTML preview will appear here after conversion."]</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @* Public Sharing Section *@
            @if ((User.Identity?.IsAuthenticated ?? false) && Model.IsEditing)
            {
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-end">
                            <div class="card border-info share-card" style="min-width:260px;">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">
                                        <i class="align-middle" data-lucide="share-2"></i>
                                        @Localizer["Share Publicly"]
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-2">@Localizer["Share this document publicly with a unique link that anyone can access without logging in."]</p>
                                    @if (Model.IsPublic && Model.PublicId.HasValue)
                                    {
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="public-link" readonly
                                                value="@Model.PublicLink" />
                                            <button class="btn btn-outline-info" type="button" id="copy-link-button"
                                                title="@Localizer["Copy link to clipboard"]">
                                                <i class="align-middle" data-lucide="copy"></i>
                                                @Localizer["Copy Link"]
                                            </button>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <button class="btn btn-outline-danger btn-sm" type="button"
                                                id="make-private-button">
                                                <i class="align-middle" data-lucide="lock"></i>
                                                @Localizer["Make Private"]
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="d-flex justify-content-end">
                                            <button class="btn btn-info" type="button" id="make-public-button">
                                                <i class="align-middle" data-lucide="unlock"></i>
                                                @Localizer["Make Public"]
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

        </div>
    </div>

    @* Submit Button Row *@
    <div class="row mt-3">
        <div class="col text-center">
            @* Add the back button *@
            @if ((User.Identity?.IsAuthenticated ?? false) && Model.IsEditing)
            {
                <a asp-action="History" class="btn btn-outline-secondary btn-lg mr-2">
                    <i class="align-middle" data-lucide="file-text">&nbsp;</i>
                    @Localizer["My Documents"]
                </a>
            }

            <button type="submit" class="btn btn-primary btn-lg">
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <i class="align-middle" data-lucide="check-circle">&nbsp;</i>
                    @Localizer["Convert and save"]
                }
                else
                {
                    <i class="align-middle" data-lucide="chevrons-right">&nbsp;</i>
                    @Localizer["Convert to HTML"]
                }
            </button>
        </div>
    </div>

    @* Public Sharing Section moved to the right column above Code/Preview tabs *@
</form>

@{
    var isDarkMode = Context.Request.Cookies[ThemeController.ThemeCookieKey] == true.ToString();
    var theme = isDarkMode ? "material" : "eclipse";
}

@* Confirmation modal for making a document private *@
<div class="modal fade" id="confirmPrivateModal" tabindex="-1" aria-labelledby="confirmPrivateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmPrivateModalLabel">@Localizer["Make document private"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>@Localizer["After making this document private, the existing public link will no longer work. Are you sure you want to proceed?"]</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-danger" id="confirm-make-private">@Localizer["Make Private"]</button>
            </div>
        </div>
    </div>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section styles {
    <link rel="stylesheet" href="~/node_modules/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" href="~/node_modules/codemirror/theme/@(theme).css" />
    <style>
        .share-card {
            width: 100%;
        }
    </style>
    <style>
        .CodeMirror,
        #preview {
            max-height: 70vh;
        }

        #preview {
            overflow-y: auto;
        }

        .CodeMirror {
            border: 1px solid #dee2e6;
            height: auto;
            display: flex;
            flex-direction: column;
        }

        .CodeMirror-scroll {
            flex-grow: 1;
            overflow: auto !important;
            position: relative;
        }

        .mermaid svg,
        svg[id^="m-"] {
            width: 100%;
            max-width: 100%;
            height: auto;
        }

        @@media print {
            @@page {
                margin-top: 2cm;
                margin-bottom: 2cm;
            }

            body * {
                visibility: hidden;
            }

            #printable-area,
            #printable-area * {
                visibility: visible;
            }

            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1.2cm;
            }

            #printable-area pre,
            #printable-area code {
                white-space: pre-wrap !important;
                overflow-wrap: break-word;
                word-wrap: break-word;
                color: #222 !important;
            }

            #printable-area {
                font-family: Georgia, "Times New Roman", serif;
                font-size: 12pt;
                svg[id^="m-"];
                line-height: 1.5;
                color: #000 !important;
            }

            #printable-area strong,
            #printable-area b {
                font-weight: 700 !important;
                /* Use a heavy font-weight */
                color: inherit !important;
            }

            #printable-area h1,
            #printable-area h2,
            #printable-area h3 {
                margin-top: 24pt;
                margin-bottom: 12pt;
            }

            #printable-area a[href]::after {
                content: " (" attr(href) ")";
                font-size: 9pt;
                color: #555;
            }

            #printable-area table {
                width: 100%;
                svg[id^="m-"];
                border-collapse: collapse;
                margin-top: 1rem;
                font-size: 11pt;
            }

            #printable-area th,
            #printable-area td {
                border: 1px solid #ccc;
                padding: 0.5rem;
                text-align: left;
            }
        }
    </style>
}

@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script src="~/node_modules/codemirror/lib/codemirror.js"></script>
    <script src="~/node_modules/codemirror/mode/markdown/markdown.js"></script>
    <script src="~/node_modules/codemirror/mode/xml/xml.js"></script>
    <script src="~/node_modules/codemirror/addon/edit/closebrackets.js"></script>
    <script src="~/node_modules/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="~/node_modules/mermaid/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let markdownEditorInstance;
            let htmlOutputInstance;

            // --- jQuery Validation Setup. Don't ignore hidden fields (CodeMirror will hide the original textarea) ---
            if ($.validator) {
                $.validator.setDefaults({
                    ignore: []
                });
            }

            // --- CodeMirror Initialization ---
            if (typeof CodeMirror !== 'undefined') {
                if (!document.getElementById('markdown-editor').CodeMirror) {
                    markdownEditorInstance = CodeMirror.fromTextArea(document.getElementById('markdown-editor'), {
                        lineNumbers: true,
                        mode: 'markdown',
                        theme: '@(theme)',
                        viewportMargin: Infinity
                    });

                    markdownEditorInstance.on('change', function () {
                        // For validator to work, we need to update the underlying textarea
                        markdownEditorInstance.save();
                    });
                }
                if (!document.getElementById('html-output').CodeMirror) {
                    htmlOutputInstance = CodeMirror.fromTextArea(document.getElementById('html-output'), {
                        lineNumbers: true,
                        mode: 'xml',
                        readOnly: true,
                        theme: '@(theme)',
                        viewportMargin: Infinity
                    });
                }
            }

            // --- Copy to Clipboard Handling ---
            const copyButton = document.getElementById('copy-button');
            if (copyButton && htmlOutputInstance) {
                copyButton.addEventListener('click', function () {
                    const codeToCopy = htmlOutputInstance.getValue();
                    if (!codeToCopy) {
                        return;
                    }
                    navigator.clipboard.writeText(codeToCopy).then(function () {
                        copyButton.innerHTML = `@Localizer["Copied!"]`;
                    }, function (err) {
                        console.error('Could not copy text: ', err);
                        confirm('@Localizer["Failed to copy text."]');
                    });
                });
            }

            // --- Theme Toggle Handling ---
            const themeToggleButton = document.querySelector('.js-theme-toggle');
            const markdownForm = document.getElementById('markdown-form');
            if (themeToggleButton && markdownForm) {
                themeToggleButton.addEventListener('click', function () {
                    // Submit the form after switching theme to refresh CodeMirror themes
                    setTimeout(() => {
                        markdownForm.submit();
                    }, 1000);
                });
            }

            // --- Styling Tables in the Preview Pane ---
            function stylePreviewTables() {
                const previewArea = document.getElementById('preview');
                if (!previewArea) return;
                const tables = previewArea.querySelectorAll('table');
                tables.forEach(table => {
                    table.classList.add('table', 'table-striped', 'table-bordered');
                    if (!table.parentElement.classList.contains('table-responsive')) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'table-responsive';
                        table.parentNode.insertBefore(wrapper, table);
                        wrapper.appendChild(table);
                    }
                });
            }
            stylePreviewTables();

            // --- Mermaid initialization and rendering in Preview ---
            if (window.mermaid) {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: '@(isDarkMode ? "dark" : "default")',
                    flowchart: { useMaxWidth: true },
                    sequence: { useMaxWidth: true }
                });
            }

            function renderMermaidInPreview() {
                const previewPane = document.getElementById('preview');
                if (!previewPane || !window.mermaid) return;
                const mermaidBlocks = previewPane.querySelectorAll('pre.mermaid, .mermaid');
                if (mermaidBlocks.length === 0) return;
                // Render each block
                mermaidBlocks.forEach((block, index) => {
                    const code = block.textContent || '';
                    const id = 'm-' + (index + 1) + '-' + Math.random().toString(36).slice(2);
                    try {
                        mermaid.parse(code);
                        mermaid.render(id, code).then(({ svg }) => {
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = svg;
                            block.replaceWith(wrapper);
                        }).catch(err => {
                            const errPre = document.createElement('pre');
                            errPre.className = 'text-danger';
                            errPre.textContent = (err && (err.message || err)) || 'Mermaid render error';
                            block.replaceWith(errPre);
                        });
                    } catch (e) {
                        const errPre = document.createElement('pre');
                        errPre.className = 'text-danger';
                        errPre.textContent = (e && (e.message || e)) || 'Mermaid parse error';
                        block.replaceWith(errPre);
                    }
                });
            }

            // Render when switching to Preview tab and on load (if already active)
            const previewTabLink = document.querySelector('a[href="#preview"][data-bs-toggle="tab"]');
            if (previewTabLink) {
                previewTabLink.addEventListener('shown.bs.tab', function () {
                    renderMermaidInPreview();
                });
            }
            // If the preview tab is active on load, render immediately
            const previewPane = document.getElementById('preview');
            if (previewPane && previewPane.classList.contains('active')) {
                renderMermaidInPreview();
            }

            // --- Print Button Handling ---
            const printButton = document.getElementById('print-button');
            if (printButton) {
                printButton.addEventListener('click', function () {
                    window.print();
                });
            }

            // --- Public/Private Share Handling ---
            const makePublicButton = document.getElementById('make-public-button');
            const makePrivateButton = document.getElementById('make-private-button');
            const copyLinkButton = document.getElementById('copy-link-button');
            const publicLinkInput = document.getElementById('public-link');
            const documentId = document.querySelector('input[name="DocumentId"]')?.value;

            if (makePublicButton) {
                makePublicButton.addEventListener('click', async function () {
                    try {
                        const response = await fetch('@Url.Action("MakePublic", "Home")/' + documentId, {
                            method: 'POST',
                            headers: {
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || '',
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            // Reload the page to show the public link
                            window.location.reload();
                        } else {
                            confirm('@Localizer["Failed to make document public. Please try again."]');
                        }
                    } catch (error) {
                        console.error('Error making document private:', error);
                        confirm('@Localizer["An error occurred. Please try again."]');
                    }
                });
            }

            if (makePrivateButton) {
                // Show bootstrap modal for confirmation instead of native confirm
                makePrivateButton.addEventListener('click', function () {
                    const modalEl = document.getElementById('confirmPrivateModal');
                    if (modalEl && window.bootstrap && bootstrap.Modal) {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    } else {
                        // Fallback to confirm if bootstrap/modal not available
                        if (!confirm('@Localizer["Are you sure you want to make this document private?"]')) {
                            return;
                        }
                        // proceed with making private
                        doMakePrivate();
                    }
                });
            }

            const confirmMakePrivateBtn = document.getElementById('confirm-make-private');
            if (confirmMakePrivateBtn) {
                confirmMakePrivateBtn.addEventListener('click', function () {
                    // disable button to prevent double submit
                    confirmMakePrivateBtn.disabled = true;
                    doMakePrivate().finally(() => {
                        confirmMakePrivateBtn.disabled = false;
                    });
                });
            }

            async function doMakePrivate() {
                try {
                    const response = await fetch('@Url.Action("MakePrivate", "Home")/' + documentId, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || '',
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        // hide modal if present then reload
                        const modalEl = document.getElementById('confirmPrivateModal');
                        if (modalEl && window.bootstrap && bootstrap.Modal) {
                            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                            modal.hide();
                        }
                        window.location.reload();
                    } else {
                        confirm('@Localizer["Failed to make document private. Please try again."]');
                    }
                } catch (error) {
                    console.error('Error making document private:', error);
                    confirm('@Localizer["An error occurred. Please try again."]');
                }
            }

            if (copyLinkButton && publicLinkInput) {
                copyLinkButton.addEventListener('click', function () {
                    publicLinkInput.select();
                    navigator.clipboard.writeText(publicLinkInput.value).then(function () {
                        copyLinkButton.innerHTML = `<i class="align-middle" data-lucide="check"></i> @Localizer["Copied!"]`;
                        setTimeout(function () {
                            copyLinkButton.innerHTML = `<i class="align-middle" data-lucide="copy"></i> @Localizer["Copy Link"]`;
                        }, 2000);
                    }, function (err) {
                        console.error('Could not copy link: ', err);
                        confirm('@Localizer["Failed to copy link."]');
                    });
                });
            }
        });
    </script>
}
