@using Aiursoft.MarkToHtml.Controllers
@model Aiursoft.MarkToHtml.Models.HomeViewModels.IndexViewModel

<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3>@Localizer["Markdown to HTML Converter"]</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <p class="mb-0 text-muted">@Localizer["A simple tool to convert your Markdown into clean, sanitized HTML."]</p>
    </div>
</div>

@if (Model.SavedSuccessfully)
{
    <div class="alert alert-success alert-dismissible" role="alert">
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        <div class="d-flex">
            <div class="alert-icon pe-3">
                <i class="align-middle" data-lucide="alert-triangle"></i>
            </div>
            <div class="alert-message">
                <strong>@Localizer["Success!"]</strong>
                @Localizer["Document updated successfully."]
            </div>
        </div>
    </div>
}

<form asp-action="Index" method="post" id="markdown-form">
    <div class="row" style="height: calc(100vh - 240px); min-height: 500px;">

        @* --- Left Column: Markdown Input --- *@
        <div class="col-lg-6 h-100 pb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-header border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="align-middle" data-lucide="file-text">&nbsp;</i>
                        @Localizer["Markdown Input"]
                    </h5>
                </div>
                <div class="card-body p-0 d-flex flex-column h-100">

                    <div class="toolbar-container border-bottom p-2 d-flex align-items-center flex-shrink-0">
                        @if (Model.IsEditing)
                        {
                            <input type="hidden" asp-for="DocumentId" />
                            <div class="input-group input-group-sm w-100">
                                <span class="input-group-text bg-white text-muted">@Localizer["Title"]</span>
                                <input asp-for="Title" class="form-control" placeholder="@Localizer["Untitled Document"]" />
                            </div>
                        }
                        else
                        {
                            <span class="text-muted small ms-2">@Localizer["Create a new document..."]</span>
                        }
                    </div>

                    @* 编辑器区域 *@
                    <div class="flex-grow-1 position-relative editor-wrapper">
                        <textarea asp-for="InputMarkdown" class="form-control" id="markdown-editor"
                            placeholder="@Localizer["Type your Markdown here..."]"></textarea>
                    </div>
                    <span asp-validation-for="InputMarkdown" class="text-danger px-2"></span>
                </div>
            </div>
        </div>

        @* --- Right Column: Output & Settings --- *@
        <div class="col-lg-6 h-100 pb-3">
            <div class="card h-100 shadow-sm">
                @* 右侧 Header *@
                <div class="card-header border-bottom d-flex align-items-center justify-content-between pt-2 pb-0 flex-shrink-0" style="min-height: 49px;">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" href="#code" data-bs-toggle="tab" role="tab" aria-selected="true">
                                <i class="align-middle" data-lucide="code-2">&nbsp;</i> @Localizer["Code"]
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#preview" data-bs-toggle="tab" role="tab" aria-selected="false">
                                <i class="align-middle" data-lucide="eye">&nbsp;</i> @Localizer["Preview"]
                            </a>
                        </li>
                    </ul>

                    @if ((User.Identity?.IsAuthenticated ?? false) && Model.IsEditing)
                    {
                        @* 修复：使用 Bootstrap Dropdown 替代原生 Select 以避免定位 bug *@
                        <div class="dropdown ms-auto mb-2">
                            <button class="btn btn-sm btn-light border dropdown-toggle d-flex align-items-center justify-content-between"
                                    type="button"
                                    id="privacyDropdownBtn"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    style="min-width: 140px;">
                                @if (Model.PublicId.HasValue)
                                {
                                    <span class="text-success fw-bold"><i class="align-middle" data-lucide="globe"></i> @Localizer["Public"]</span>
                                }
                                else
                                {
                                    <span class="text-secondary"><i class="align-middle" data-lucide="lock"></i> @Localizer["Private"]</span>
                                }
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="privacyDropdownBtn">
                                <li>
                                    <button class="dropdown-item" type="button" data-action="set-privacy" data-value="private">
                                        <i class="align-middle me-1" data-lucide="lock"></i> @Localizer["Private - Only you"]
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" type="button" data-action="set-privacy" data-value="public">
                                        <i class="align-middle me-1" data-lucide="globe"></i> @Localizer["Public - Anyone with link"]
                                    </button>
                                </li>
                            </ul>
                            @* 隐藏域存储当前状态供 JS 读取 *@
                            <input type="hidden" id="current-privacy-state" value="@(Model.PublicId.HasValue ? "public" : "private")" />
                        </div>
                    }
                </div>

                <div class="card-body p-0 d-flex flex-column overflow-hidden">

                    <div class="tab-content flex-grow-1 d-flex flex-column p-0" style="height: 100%;">

                        @* --- Code Pane --- *@
                        <div class="tab-pane active show flex-column h-100" id="code" role="tabpanel">

                             @* 右侧工具栏 *@
                             <div class="toolbar-container border-bottom p-2 d-flex align-items-center justify-content-between flex-shrink-0">
                                <div class="small text-muted flex-grow-1 me-2">
                                    @if (Model.PublicId.HasValue)
                                    {
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control bg-white" id="public-link" readonly value="@Model.PublicLink" />
                                            <button class="btn btn-outline-secondary" type="button" id="copy-link-button" title="@Localizer["Copy Link"]">
                                                <i class="align-middle" data-lucide="link"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                                <button type="button" id="copy-button" class="btn btn-sm btn-white border shadow-sm text-primary flex-shrink-0">
                                    <i class="align-middle" data-lucide="copy"></i> @Localizer["Copy HTML"]
                                </button>
                            </div>

                            <div class="flex-grow-1 position-relative editor-wrapper">
                                <textarea class="form-control" id="html-output" readonly>@Model.OutputHtml</textarea>
                            </div>
                        </div>

                        @* --- Preview Pane --- *@
                        <div class="tab-pane flex-column h-100" id="preview" role="tabpanel">
                            <div class="toolbar-container border-bottom p-2 d-flex align-items-center justify-content-end flex-shrink-0">
                                <button type="button" id="print-button" class="btn btn-sm btn-white border shadow-sm text-info">
                                    <i class="align-middle" data-lucide="printer"></i> @Localizer["Print"]
                                </button>
                            </div>

                            <div class="flex-grow-1 overflow-auto p-4 markdown-content" id="printable-area">
                                @Html.Raw(Model.OutputHtml)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Submit Button Row *@
    <div class="row mt-3">
        <div class="col text-center">
            @if ((User.Identity?.IsAuthenticated ?? false) && Model.IsEditing)
            {
                <a asp-action="History" class="btn btn-outline-secondary btn-lg mr-2">
                    <i class="align-middle" data-lucide="arrow-left">&nbsp;</i>
                    @Localizer["My Documents"]
                </a>
            }

            <button type="submit" class="btn btn-primary btn-lg shadow">
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <i class="align-middle" data-lucide="save">&nbsp;</i>
                    @Localizer["Save Changes"]
                }
                else
                {
                    <i class="align-middle" data-lucide="play">&nbsp;</i>
                    @Localizer["Convert to HTML"]
                }
            </button>
        </div>
    </div>
</form>

@{
    var isDarkMode = Context.Request.Cookies[ThemeController.ThemeCookieKey] == true.ToString();
    var theme = isDarkMode ? "material" : "eclipse";
}

@* Confirmation modal *@
<div class="modal fade" id="confirmPrivateModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@Localizer["Change to Private?"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>@Localizer["If you make this document private, the existing public link will immediately stop working for everyone."] @Localizer["Are you sure?"]</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancel-private-action">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-danger" id="confirm-make-private">@Localizer["Yes, Make Private"]</button>
            </div>
        </div>
    </div>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section styles {
    <link rel="stylesheet" href="~/node_modules/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" href="~/node_modules/codemirror/theme/@(theme).css" />

    <link rel="stylesheet" href="~/styles/markdown-reader.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/styles/markdown-editor.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/styles/markdown-print.css"  asp-append-version="true" />
}

@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script src="~/node_modules/codemirror/lib/codemirror.js"></script>
    <script src="~/node_modules/codemirror/mode/markdown/markdown.js"></script>
    <script src="~/node_modules/codemirror/mode/xml/xml.js"></script>
    <script src="~/node_modules/codemirror/addon/edit/closebrackets.js"></script>
    <script src="~/node_modules/codemirror/addon/edit/matchbrackets.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="~/node_modules/mermaid/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let markdownEditorInstance, htmlOutputInstance;
            if ($.validator) $.validator.setDefaults({ ignore: [] });

            // --- CodeMirror Setup ---
            if (typeof CodeMirror !== 'undefined') {
                if (!document.getElementById('markdown-editor').CodeMirror) {
                    markdownEditorInstance = CodeMirror.fromTextArea(document.getElementById('markdown-editor'), {
                        lineNumbers: true, mode: 'markdown', theme: '@(theme)', viewportMargin: Infinity
                    });
                    markdownEditorInstance.on('change', () => markdownEditorInstance.save());
                }
                if (!document.getElementById('html-output').CodeMirror) {
                    htmlOutputInstance = CodeMirror.fromTextArea(document.getElementById('html-output'), {
                        lineNumbers: true, mode: 'xml', readOnly: true, theme: '@(theme)', viewportMargin: Infinity
                    });
                }
            }

            // --- Copy & Print Utils ---
            const copyButton = document.getElementById('copy-button');
            if (copyButton && htmlOutputInstance) {
                copyButton.addEventListener('click', function () {
                    const val = htmlOutputInstance.getValue();
                    if (!val) return;
                    navigator.clipboard.writeText(val).then(
                        () => { let h = copyButton.innerHTML; copyButton.innerHTML = `<i class="align-middle" data-lucide="check"></i> @Localizer["Copied!"]`; setTimeout(() => copyButton.innerHTML = h, 2000); },
                        (err) => console.error(err)
                    );
                });
            }
            const themeBtn = document.querySelector('.js-theme-toggle');
            if (themeBtn) themeBtn.addEventListener('click', () => setTimeout(() => document.getElementById('markdown-form').submit(), 1000));
            const printBtn = document.getElementById('print-button');
            if (printBtn) printBtn.addEventListener('click', () => window.print());

            // --- Table & Mermaid Rendering ---
            function stylePreviewTables() {
                const p = document.getElementById('preview');
                if(!p) return;
                p.querySelectorAll('table').forEach(t => {
                    t.classList.add('table', 'table-striped', 'table-bordered');
                    if (!t.parentElement.classList.contains('table-responsive')) {
                        const w = document.createElement('div'); w.className = 'table-responsive';
                        t.parentNode.insertBefore(w, t); w.appendChild(t);
                    }
                });
            }
            stylePreviewTables();
            if (window.mermaid) mermaid.initialize({ startOnLoad: false, theme: '@(isDarkMode ? "dark" : "default")' });
            function renderMermaid() {
                const p = document.getElementById('preview');
                if (!p || !window.mermaid) return;
                p.querySelectorAll('pre.mermaid, .mermaid').forEach((b, i) => {
                    const code = b.textContent || '';
                    const id = 'm-' + (i + 1) + '-' + Math.random().toString(36).slice(2);
                    try {
                        mermaid.parse(code);
                        mermaid.render(id, code).then(({ svg }) => {
                            const w = document.createElement('div'); w.innerHTML = svg; b.replaceWith(w);
                        }).catch(e => console.error(e));
                    } catch (e) { console.error(e); }
                });
            }
            const prevTab = document.querySelector('a[href="#preview"]');
            if (prevTab) prevTab.addEventListener('shown.bs.tab', renderMermaid);
            if (document.getElementById('preview')?.classList.contains('active')) renderMermaid();

            // --- MathJax Rendering ---
            function renderMath() {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    const preview = document.getElementById('preview');
                    if(preview) window.MathJax.typesetPromise([preview]);
                }
            }
            if (prevTab) prevTab.addEventListener('shown.bs.tab', renderMath);
            if (document.getElementById('preview')?.classList.contains('active')) renderMath();

            // --- Privacy Dropdown Logic (Updated) ---
            const modalEl = document.getElementById('confirmPrivateModal');
            const docId = document.querySelector('input[name="DocumentId"]')?.value;
            const currentStateEl = document.getElementById('current-privacy-state');

            // Listen for clicks on Dropdown Items
            document.querySelectorAll('[data-action="set-privacy"]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const newValue = this.getAttribute('data-value');
                    const currentValue = currentStateEl ? currentStateEl.value : 'private';

                    if (newValue === currentValue) return; // No change

                    if (newValue === 'public') {
                        changeVis(true);
                    } else {
                        // Switching to private -> Show warning
                        if (window.bootstrap && bootstrap.Modal) {
                            new bootstrap.Modal(modalEl).show();
                        } else if (confirm('@Localizer["Are you sure?"]')) {
                            changeVis(false);
                        }
                    }
                });
            });

            // Modal Confirm Button
            document.getElementById('confirm-make-private')?.addEventListener('click', function() {
                this.disabled = true;
                changeVis(false).finally(() => this.disabled = false);
            });

            async function changeVis(isPublic) {
                const url = '@Url.Action("ActionPlaceholder", "Home")'.replace('ActionPlaceholder', isPublic ? 'MakePublic' : 'MakePrivate') + '/' + docId;
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || '', 'Content-Type': 'application/json' }
                    });
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        alert('@Localizer["Failed to update privacy settings."]');
                    }
                } catch (e) {
                    console.error(e);
                    alert('@Localizer["An error occurred."]');
                }
            }

            // --- Public Link Copy ---
            const cpLink = document.getElementById('copy-link-button');
            const pubInp = document.getElementById('public-link');
            if (cpLink && pubInp) {
                cpLink.addEventListener('click', () => {
                    pubInp.select();
                    navigator.clipboard.writeText(pubInp.value).then(() => {
                        let h = cpLink.innerHTML; cpLink.innerHTML = `Copied!`;
                        setTimeout(() => cpLink.innerHTML = h, 2000);
                    });
                });
            }
        });
    </script>
}
