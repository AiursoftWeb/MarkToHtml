@using Aiursoft.MarkToHtml.Controllers
@model Aiursoft.MarkToHtml.Models.HomeViewModels.IndexViewModel

<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3>@Localizer["Markdown to HTML Converter"]</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <p class="mb-0 text-muted">@Localizer["A simple tool to convert your Markdown into clean, sanitized HTML."]</p>
    </div>
</div>

@if (Model.SavedSuccessfully)
{
    <div class="alert alert-success alert-dismissible" role="alert">
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        <div class="d-flex">
            <div class="alert-icon pe-3">
                <i class="align-middle" data-lucide="alert-triangle"></i>
            </div>
            <div class="alert-message">
                <strong>@Localizer["Success!"]</strong>
                @Localizer["Document updated successfully."]
            </div>
        </div>
    </div>
}

<form asp-action="Index" method="post" id="markdown-form">
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        @* Desktop View Switcher *@
                        <div class="btn-group btn-group-sm me-3 d-none d-lg-inline-block" role="group" aria-label="View mode" id="view-mode-switcher-desktop">
                            <input type="radio" class="btn-check" name="view-mode-desktop" id="view-split-desktop" value="split" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary" for="view-split-desktop" title="@Localizer["Split View"]"><i class="align-middle" data-lucide="columns"></i></label>

                            <input type="radio" class="btn-check" name="view-mode-desktop" id="view-editor-desktop" value="editor" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="view-editor-desktop" title="@Localizer["Editor Only"]"><i class="align-middle" data-lucide="edit-3"></i></label>

                            <input type="radio" class="btn-check" name="view-mode-desktop" id="view-preview-desktop" value="preview" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="view-preview-desktop" title="@Localizer["Preview Only"]"><i class="align-middle" data-lucide="eye"></i></label>
                        </div>

                        @* Mobile View Switcher *@
                        <div class="btn-group btn-group-sm me-3 d-lg-none" role="group" aria-label="Mobile view mode" id="view-mode-switcher-mobile">
                            <input type="radio" class="btn-check" name="view-mode-mobile" id="view-editor-mobile" value="editor" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary" for="view-editor-mobile" title="@Localizer["Editor"]"><i class="align-middle" data-lucide="edit-3"></i></label>

                            <input type="radio" class="btn-check" name="view-mode-mobile" id="view-preview-mobile" value="preview" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="view-preview-mobile" title="@Localizer["Preview"]"><i class="align-middle" data-lucide="eye"></i></label>
                        </div>

                        <div class="flex-grow-1">
                            @if (Model.IsEditing)
                            {
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white text-muted">@Localizer["Title"]</span>
                                    <input asp-for="Title" class="form-control" placeholder="@Localizer["Untitled Document"]" />
                                    <input type="hidden" asp-for="DocumentId" />
                                </div>
                            }
                            else
                            {
                                <span class="text-muted small ms-2">@Localizer["Create a new document..."]</span>
                            }
                        </div>

                        <div class="ms-auto">
                            @if (User.Identity?.IsAuthenticated ?? false)
                            {
                                if (Model.IsEditing)
                                {
                                    <a asp-action="History" class="btn btn-sm btn-outline-secondary me-1">
                                        <i class="align-middle" data-lucide="arrow-left">&nbsp;</i>
                                        <span class="d-none d-md-inline">@Localizer["My Documents"]</span>
                                    </a>
                                }
                                <button type="submit" class="btn btn-sm btn-primary shadow-sm">
                                    <i class="align-middle" data-lucide="save">&nbsp;</i>
                                    <span class="d-none d-md-inline">@Localizer["Save Changes"]</span>
                                </button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-sm btn-primary shadow-sm">
                                    <i class="align-middle" data-lucide="play">&nbsp;</i>
                                    @Localizer["Convert to HTML"]
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row" style="height: calc(100vh - 320px); min-height: 420px;">

        @* --- Left Column: Markdown Input --- *@
        <div id="editor-column" class="col-lg-6 h-100 pb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body p-0 d-flex flex-column h-100">
                    @* 编辑器区域 *@
                    <div class="flex-grow-1 position-relative editor-wrapper">
                        <div id="markdown-editor-container" style="width: 100%; height: 100%;"></div>
                        <textarea asp-for="InputMarkdown" id="markdown-editor" style="display: none;"></textarea>
                    </div>
                    <span asp-validation-for="InputMarkdown" class="text-danger px-2"></span>
                </div>
            </div>
        </div>

        @* --- Right Column: Output & Settings --- *@
        <div id="preview-column" class="col-lg-6 h-100 pb-3">
            <div class="card h-100 shadow-sm">
                @* 右侧 Header *@
                <div class="card-header border-bottom d-flex align-items-center justify-content-between pt-2 pb-0 flex-shrink-0" style="min-height: 49px;">
                    <div class="d-flex align-items-center">
                        <ul class="nav nav-tabs card-header-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a class="nav-link active" href="#code" data-bs-toggle="tab" role="tab" aria-selected="true">
                                    <i class="align-middle" data-lucide="code-2">&nbsp;</i> @Localizer["Code"]
                                </a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" href="#preview" data-bs-toggle="tab" role="tab" aria-selected="false">
                                    <i class="align-middle" data-lucide="eye">&nbsp;</i> @Localizer["Preview"]
                                </a>
                            </li>
                        </ul>
                    </div>

                    @if ((User.Identity?.IsAuthenticated ?? false) && Model.IsEditing)
                    {
                        <a asp-action="ManageShares" asp-route-id="@Model.DocumentId" class="btn btn-sm btn-light border ms-auto mb-2" target="_blank">
                            <i class="align-middle" data-lucide="share-2"></i> @Localizer["Share"]
                        </a>
                    }
                </div>

                <div class="card-body p-0 d-flex flex-column overflow-hidden">

                    <div class="tab-content flex-grow-1 d-flex flex-column p-0" style="height: 100%;">

                        @* --- Code Pane --- *@
                        <div class="tab-pane active show flex-column h-100" id="code" role="tabpanel">

                            @* 右侧工具栏 *@
                            <div class="toolbar-container border-bottom p-2 d-flex align-items-center justify-content-between flex-shrink-0">
                                <div class="small text-muted flex-grow-1 me-2">
                                    @if (Model.IsPublic)
                                    {
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control bg-white" id="public-link" readonly value="@Model.PublicLink" />
                                            <button class="btn btn-outline-secondary" type="button" id="copy-link-button" title="@Localizer["Copy Link"]">
                                                <i class="align-middle" data-lucide="link"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                                <button type="button" id="copy-button" class="btn btn-sm btn-white border shadow-sm text-primary flex-shrink-0">
                                    <i class="align-middle" data-lucide="copy"></i> @Localizer["Copy HTML"]
                                </button>
                            </div>

                            <div class="flex-grow-1 position-relative editor-wrapper">
                                <div id="html-output-container" style="width: 100%; height: 100%;"></div>
                                <textarea id="html-output" style="display: none;">@Model.OutputHtml</textarea>
                            </div>
                        </div>

                        @* --- Preview Pane --- *@
                        <div class="tab-pane flex-column h-100" id="preview" role="tabpanel">
                            <div class="toolbar-container border-bottom p-2 d-flex align-items-center justify-content-end flex-shrink-0">
                                <button type="button" id="print-button" class="btn btn-sm btn-white border shadow-sm text-info">
                                    <i class="align-middle" data-lucide="printer"></i> @Localizer["Print"]
                                </button>
                            </div>

                            <div class="flex-grow-1 overflow-auto p-4 markdown-content" id="printable-area">
                                @Html.Raw(Model.OutputHtml)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@{
    var isDarkMode = Context.Request.Cookies[ThemeController.ThemeCookieKey] == true.ToString();
}

@* ReSharper disable once Razor.SectionNotResolved *@
@section styles {
    <link rel="stylesheet" href="~/styles/markdown-reader.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/styles/markdown-editor.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/styles/markdown-print.css"  asp-append-version="true" />
    @if (isDarkMode)
    {
        <link rel="stylesheet" href="~/node_modules/@@highlightjs/cdn-assets/styles/github-dark.min.css" asp-append-version="true" />
    }
    else
    {
        <link rel="stylesheet" href="~/node_modules/@@highlightjs/cdn-assets/styles/github.min.css" asp-append-version="true" />
    }
    <style>
        @@media (max-width: 991.98px) {
            #editor-column,
            #preview-column {
                width: 100%;
                display: none;
            }

            .view-mode-editor #editor-column,
            .view-mode-preview #preview-column {
                display: block;
            }
        }
    </style>
}

@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script>var require = { paths: { 'vs': '/node_modules/monaco-editor/min/vs' } };</script>
    <script src="~/node_modules/monaco-editor/min/vs/loader.js" asp-append-version="true"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="~/node_modules/mathjax/es5/tex-mml-chtml.js" asp-append-version="true"></script>
    <script src="~/node_modules/mermaid/dist/mermaid.min.js" asp-append-version="true"></script>
    <script src="~/node_modules/@@highlightjs/cdn-assets/highlight.min.js" asp-append-version="true"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            require(['vs/editor/editor.main'], function () {
                let markdownEditorInstance, htmlOutputInstance;
                const markdownEditorElement = document.getElementById('markdown-editor');
                const htmlOutputElement = document.getElementById('html-output');
                const monacoTheme = '@(isDarkMode ? "vs-dark" : "vs")';

                // --- Monaco Editor Setup ---
                if (markdownEditorElement) {
                    markdownEditorInstance = monaco.editor.create(document.getElementById('markdown-editor-container'), {
                        value: markdownEditorElement.value,
                        language: 'markdown',
                        theme: monacoTheme,
                        automaticLayout: true,
                        wordWrap: 'on',
                        'semanticHighlighting.enabled': true
                    });

                    // --- Unsaved Changes Warning ---
                    let isDirty = false;
                    const isAuthenticated = @((User.Identity?.IsAuthenticated ?? false).ToString().ToLower());

                    if (isAuthenticated) {
                        window.addEventListener('beforeunload', function (e) {
                            if (isDirty) {
                                e.preventDefault();
                                e.returnValue = '';
                            }
                        });

                        const form = document.getElementById('markdown-form');
                        if (form) {
                            form.addEventListener('submit', () => {
                                isDirty = false;
                            });
                        }

                        const titleInput = document.getElementById('Title');
                        if (titleInput) {
                            titleInput.addEventListener('input', () => {
                                isDirty = true;
                            });
                        }
                    }

                    markdownEditorInstance.onDidChangeModelContent(() => {
                        const currentValue = markdownEditorInstance.getValue();
                        markdownEditorElement.value = currentValue;
                        markdownEditorElement.dispatchEvent(new Event('change'));

                        if (isAuthenticated) {
                            isDirty = true;
                        }
                    });

                    // --- Markdown All In One Features ---

                    // 1. Enter Key Handler for List Continuation
                    markdownEditorInstance.onKeyDown((e) => {
                        if (e.keyCode === monaco.KeyCode.Enter && !e.ctrlKey && !e.altKey && !e.metaKey && !e.shiftKey) {
                            const position = markdownEditorInstance.getPosition();
                            const model = markdownEditorInstance.getModel();
                            const lineContent = model.getLineContent(position.lineNumber);

                            const unorderedMatch = lineContent.match(/^(\s*)([\-\*\+])\s(.*)$/);
                            const orderedMatch = lineContent.match(/^(\s*)(\d+)(\.)\s(.*)$/);

                            if (unorderedMatch) {
                                e.preventDefault();
                                e.stopPropagation();
                                const indent = unorderedMatch[1];
                                const marker = unorderedMatch[2];
                                const content = unorderedMatch[3];

                                if (!content.trim()) {
                                    markdownEditorInstance.executeEdits('markdown-list', [{
                                        range: new monaco.Range(position.lineNumber, 1, position.lineNumber, lineContent.length + 1),
                                        text: '',
                                        forceMoveMarkers: true
                                    }]);
                                } else {
                                    const insertText = `\n${indent}${marker} `;
                                    markdownEditorInstance.executeEdits('markdown-list', [{
                                        range: new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column),
                                        text: insertText,
                                        forceMoveMarkers: true
                                    }]);
                                    markdownEditorInstance.setPosition({
                                        lineNumber: position.lineNumber + 1,
                                        column: insertText.length
                                    });
                                    markdownEditorInstance.revealPositionInCenterIfOutsideViewport(markdownEditorInstance.getPosition());
                                }
                            } else if (orderedMatch) {
                                e.preventDefault();
                                e.stopPropagation();
                                const indent = orderedMatch[1];
                                const number = parseInt(orderedMatch[2]);
                                const dot = orderedMatch[3];
                                const content = orderedMatch[4];

                                if (!content.trim()) {
                                    markdownEditorInstance.executeEdits('markdown-list', [{
                                        range: new monaco.Range(position.lineNumber, 1, position.lineNumber, lineContent.length + 1),
                                        text: '',
                                        forceMoveMarkers: true
                                    }]);
                                } else {
                                    const edits = [];
                                    const nextNumber = number + 1;
                                    const insertText = `\n${indent}${nextNumber}${dot} `;

                                    // Insert the new list item
                                    edits.push({
                                        range: new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column),
                                        text: insertText,
                                        forceMoveMarkers: true
                                    });

                                    // Renumber subsequent list items
                                    for (let i = position.lineNumber + 1; i <= model.getLineCount(); i++) {
                                        const nextLine = model.getLineContent(i);
                                        const nextLineMatch = nextLine.match(/^(\s*)(\d+)(\.)\s(.*)$/);
                                        if (nextLineMatch && nextLineMatch[1] === indent) {
                                            const oldNum = parseInt(nextLineMatch[2]);
                                            const newNum = oldNum + 1;
                                            const newLineText = `${indent}${newNum}${dot} ${nextLineMatch[4]}`;
                                            edits.push({
                                                range: new monaco.Range(i, 1, i, nextLine.length + 1),
                                                text: newLineText
                                            });
                                        } else {
                                            break; // Not a list item or different indentation
                                        }
                                    }

                                    markdownEditorInstance.executeEdits('markdown-list-renumber', edits);
                                    markdownEditorInstance.setPosition({
                                        lineNumber: position.lineNumber + 1,
                                        column: insertText.length
                                    });
                                    markdownEditorInstance.revealPositionInCenterIfOutsideViewport(markdownEditorInstance.getPosition());
                                }
                            }
                        }
                    });

                    // 2. Shortcuts

                    function wrapSelection(startStr, endStr) {
                        const selection = markdownEditorInstance.getSelection();
                        const model = markdownEditorInstance.getModel();
                        const text = model.getValueInRange(selection);

                        markdownEditorInstance.executeEdits('markdown-shortcut', [{
                            range: selection,
                            text: `${startStr}${text}${endStr}`,
                            forceMoveMarkers: true
                        }]);
                    }

                    markdownEditorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyB, () => wrapSelection('**', '**'));
                    markdownEditorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyI, () => wrapSelection('*', '*'));

                    markdownEditorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyK, () => {
                        const selection = markdownEditorInstance.getSelection();
                        if (selection.startLineNumber !== selection.endLineNumber) {
                            wrapSelection('```\n', '\n```');
                        } else {
                            wrapSelection('`', '`');
                        }
                    });

                    markdownEditorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyL, () => wrapSelection('[', '](url)'));

                    for (let i = 1; i <= 6; i++) {
                        markdownEditorInstance.addCommand(monaco.KeyMod.CtrlCmd | (monaco.KeyCode.Digit0 + i), () => {
                            const position = markdownEditorInstance.getPosition();
                            const model = markdownEditorInstance.getModel();
                            const lineContent = model.getLineContent(position.lineNumber);

                            const cleanContent = lineContent.replace(/^#+\s*/, '');
                            const hashes = '#'.repeat(i) + ' ';

                            markdownEditorInstance.executeEdits('markdown-heading', [{
                                range: new monaco.Range(position.lineNumber, 1, position.lineNumber, lineContent.length + 1),
                                text: hashes + cleanContent,
                                forceMoveMarkers: true
                            }]);
                        });
                    }
                }

                if (htmlOutputElement) {
                    htmlOutputInstance = monaco.editor.create(document.getElementById('html-output-container'), {
                        value: htmlOutputElement.value,
                        language: 'html',
                        theme: monacoTheme,
                        readOnly: true,
                        automaticLayout: true,
                        wordWrap: 'on'
                    });
                }

                // --- Markdown Completion Provider ---
                monaco.languages.registerCompletionItemProvider('markdown', {
                    provideCompletionItems: function(model, position) {
                        const word = model.getWordUntilPosition(position);
                        const range = {
                            startLineNumber: position.lineNumber,
                            endLineNumber: position.lineNumber,
                            startColumn: word.startColumn,
                            endColumn: word.endColumn
                        };
                        return {
                            suggestions: [{
                                label: 'table',
                                kind: monaco.languages.CompletionItemKind.Snippet,
                                insertText: [
                                    '| ${1:Header1} | ${2:Header2} |',
                                    '|---|---|',
                                    '| ${3:Content1} | ${4:Content2} |',
                                    ''
                                ].join('\\n'),
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Table',
                                range: range
                            }]
                        };
                    }
                });

                // --- View Mode Switcher ---
                const editorCol = document.getElementById('editor-column');
                const previewCol = document.getElementById('preview-column');
                const formRoot = document.getElementById('markdown-form');
                const radiosDesktop = document.querySelectorAll('input[name="view-mode-desktop"]');
                const radiosMobile = document.querySelectorAll('input[name="view-mode-mobile"]');

                function isMobile() {
                    return window.innerWidth < 992;
                }

                function setViewMode(mode, fromMobile) {
                    if (!editorCol || !previewCol || !formRoot) return;
                    
                    if (isMobile() && mode === 'split') {
                        mode = 'editor';
                    }
                    
                    localStorage.setItem('markdown-view-mode', mode);

                    // Sync radio buttons
                    const desktopRadio = document.querySelector(`input[name="view-mode-desktop"][value="${mode}"]`);
                    if (desktopRadio) desktopRadio.checked = true;
                    const mobileRadio = document.querySelector(`input[name="view-mode-mobile"][value="${mode}"]`);
                    if (mobileRadio) mobileRadio.checked = true;

                    // Apply classes for desktop
                    if (!isMobile()) {
                        formRoot.classList.remove('view-mode-editor', 'view-mode-preview');
                        if (mode === 'split') {
                            editorCol.classList.remove('d-none', 'col-lg-12');
                            editorCol.classList.add('col-lg-6');
                            previewCol.classList.remove('d-none', 'col-lg-12');
                            previewCol.classList.add('col-lg-6');
                        } else if (mode === 'editor') {
                            editorCol.classList.remove('d-none', 'col-lg-6');
                            editorCol.classList.add('col-lg-12');
                            previewCol.classList.add('d-none');
                        } else if (mode === 'preview') {
                            editorCol.classList.add('d-none');
                            previewCol.classList.remove('d-none', 'col-lg-6');
                            previewCol.classList.add('col-lg-12');
                            
                            const previewTabLink = document.querySelector('a[href="#preview"]');
                            if (previewTabLink) {
                                bootstrap.Tab.getOrCreateInstance(previewTabLink).show();
                            }
                        }
                    }

                    // Apply classes for mobile
                    if (isMobile()) {
                         editorCol.classList.remove('col-lg-6', 'col-lg-12', 'd-none');
                         previewCol.classList.remove('col-lg-6', 'col-lg-12', 'd-none');
                         formRoot.classList.remove('view-mode-editor', 'view-mode-preview');
                         formRoot.classList.add(`view-mode-${mode}`);
                    }
                }
                
                function applyInitialViewMode() {
                    const savedMode = localStorage.getItem('markdown-view-mode') || 'split';
                    setViewMode(savedMode);
                }

                radiosDesktop.forEach(r => r.addEventListener('change', (e) => setViewMode(e.target.value, false)));
                radiosMobile.forEach(r => r.addEventListener('change', (e) => setViewMode(e.target.value, true)));
                window.addEventListener('resize', applyInitialViewMode);
                applyInitialViewMode();

                if ($.validator) $.validator.setDefaults({ ignore: [] });

                // --- Copy & Print Utils ---
                const copyButton = document.getElementById('copy-button');
                if (copyButton && htmlOutputInstance) {
                    copyButton.addEventListener('click', function () {
                        const val = htmlOutputInstance.getValue();
                        if (!val) return;
                        navigator.clipboard.writeText(val).then(
                            () => { let h = copyButton.innerHTML; copyButton.innerHTML = `<i class="align-middle" data-lucide="check"></i> @Localizer["Copied!"]`; setTimeout(() => copyButton.innerHTML = h, 2000); },
                            (err) => console.error(err)
                        );
                    });
                }
                const themeBtn = document.querySelector('.js-theme-toggle');
                if (themeBtn) themeBtn.addEventListener('click', () => setTimeout(() => document.getElementById('markdown-form').submit(), 1000));
                const printBtn = document.getElementById('print-button');
                if (printBtn) printBtn.addEventListener('click', () => window.print());

                // --- Table & Mermaid Rendering ---
                function stylePreviewTables() {
                    const p = document.getElementById('preview');
                    if(!p) return;
                    p.querySelectorAll('table').forEach(t => {
                        t.classList.add('table', 'table-striped', 'table-bordered');
                        if (!t.parentElement.classList.contains('table-responsive')) {
                            const w = document.createElement('div'); w.className = 'table-responsive';
                            t.parentNode.insertBefore(w, t); w.appendChild(t);
                        }
                    });
                }
                stylePreviewTables();
                if (window.mermaid) mermaid.initialize({ startOnLoad: false, theme: '@(isDarkMode ? "dark" : "default")' });
                function renderMermaid() {
                    const p = document.getElementById('preview');
                    if (!p || !window.mermaid) return;
                    p.querySelectorAll('pre.mermaid, .mermaid').forEach((b, i) => {
                        const code = b.textContent || '';
                        const id = 'm-' + (i + 1) + '-' + Math.random().toString(36).slice(2);
                        try {
                            mermaid.parse(code);
                            mermaid.render(id, code).then(({ svg }) => {
                                const w = document.createElement('div'); w.innerHTML = svg; b.replaceWith(w);
                            }).catch(e => console.error(e));
                        } catch (e) { console.error(e); }
                    });
                }
                const prevTab = document.querySelector('a[href="#preview"]');
                if (prevTab) prevTab.addEventListener('shown.bs.tab', renderMermaid);
                if (document.getElementById('preview')?.classList.contains('active')) renderMermaid();

                // --- MathJax Rendering ---
                function renderMath() {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        const preview = document.getElementById('preview');
                        if(preview) window.MathJax.typesetPromise([preview]);
                    }
                }
                if (prevTab) prevTab.addEventListener('shown.bs.tab', renderMath);
                if (document.getElementById('preview')?.classList.contains('active')) renderMath();

                // --- Highlight.js Rendering ---
                function renderHighlight() {
                    if (window.hljs) {
                        hljs.highlightAll();
                    }
                }
                if (prevTab) prevTab.addEventListener('shown.bs.tab', renderHighlight);
                if (document.getElementById('preview')?.classList.contains('active')) renderHighlight();

                // --- Public Link Copy ---
                const cpLink = document.getElementById('copy-link-button');
                const pubInp = document.getElementById('public-link');
                if (cpLink && pubInp) {
                    cpLink.addEventListener('click', () => {
                        pubInp.select();
                        navigator.clipboard.writeText(pubInp.value).then(() => {
                            let h = cpLink.innerHTML; cpLink.innerHTML = `Copied!`;
                            setTimeout(() => cpLink.innerHTML = h, 2000);
                        });
                    });
                }
            });
        });
    </script>
}
